version: '3.8'

services:
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: content-generation-server
    ports:
      - "${SERVER_PORT:-8000}:8000"
    environment:
      - NODE_ENV=production
      - PORT=8000
      - HOME=/app
      - CONTENT_GEN_DIR=/app
      - DATA_DIR=/app/data
      - SCRIPTS_DIR=/app/scripts
      - LOGS_DIR=/app/logs
      - DOCKER=true
      # Load OPENAI_API_KEY from .env file (mounted below)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    env_file:
      - .env
    volumes:
      # Mount data directory for persistence (writable)
      - ./data:/app/data
      # Mount scripts directory (read-only, needed for processing)
      - ./scripts:/app/scripts:ro
      # Mount prompt files (read-only)
      - ./prompt-analyze.txt:/app/prompt-analyze.txt:ro
      - ./prompt-translate.txt:/app/prompt-translate.txt:ro
      # Mount example directories (read-only)
      - ./data/analysis-examples:/app/data/analysis-examples:ro
      - ./data/structure-examples:/app/data/structure-examples:ro
      # Mount logs directory (writable)
      - ./logs:/app/logs
      # Mount .env file (for API keys)
      - ./.env:/app/.env:ro
      # Mount node_modules from content-generation (for script dependencies)
      - ./node_modules:/app/content-generation-node_modules:ro
    working_dir: /app
    # Override command - server code is already in the image
    command: node dist/index.js
    networks:
      - content-generation-network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=http://server:8000
    container_name: content-generation-frontend
    ports:
      - "${FRONTEND_PORT:-5173}:80"
    depends_on:
      - server
    networks:
      - content-generation-network
    restart: unless-stopped

networks:
  content-generation-network:
    driver: bridge

