# Data Format Specification

This document describes the final data format for song files generated by the content generation pipeline.

## Final Format: `backend/data/songs/{videoId}.json`

The final output combines both lyrics and structured sections in a single file:

```json
{
  "videoId": "KU5V5WZVcVE",
  "title": "Song Title",
  "artist": "Artist Name",
  "thumbnailUrl": "https://...",
  "originalLanguage": "es",
  "transcribedAt": "2025-01-20T10:30:00.000Z",
  
  "lyrics": [
    {
      "text": "Nada voy a hacer, rebuscando en las heridas del pasado",
      "start_ms": 0,
      "end_ms": 2900,
      "translations": {
        "en": "I'm not going to do anything, digging into the wounds of the past",
        "es": "Nada voy a hacer, rebuscando en las heridas del pasado",
        "fr": "Je ne vais rien faire, fouillant dans les blessures du passé",
        "de": "Ich werde nichts tun, in den Wunden der Vergangenheit wühlen"
      },
      "explanations": {
        "en": "This line expresses reluctance to dwell on past pain...",
        "es": "Esta línea expresa renuencia a revolver el dolor pasado...",
        "fr": "Cette ligne exprime une réticence à s'attarder sur la douleur passée..."
      }
    }
  ],
  
  "structuredSections": [
    {
      "title": {
        "en": "Intro",
        "es": "Introducción",
        "fr": "Introduction",
        "de": "Einleitung"
      },
      "sectionExplanation": {
        "en": "The introduction sets the stage for the song...",
        "es": "La introducción establece el escenario para la canción...",
        "fr": "L'introduction établit le décor de la chanson..."
      },
      "start_ms": 0,
      "end_ms": 2000
    },
    {
      "title": {
        "en": "Chorus",
        "es": "Coro",
        "fr": "Refrain"
      },
      "sectionExplanation": {
        "en": "The chorus describes the enchanting experience...",
        "es": "El coro describe la experiencia encantadora...",
        "fr": "Le refrain décrit l'expérience enchanteresse..."
      },
      "start_ms": 34440,
      "end_ms": 50960
    }
  ]
}
```

## Key Features

### 1. Combined Format
- **`lyrics`**: All transcription lines with full i18n translations and explanations
- **`structuredSections`**: Organized sections (Intro, Verse, Chorus, etc.) with timestamp ranges
- Both in the same file for efficiency

### 2. Language Keys
- Use language codes (`es`, `en`, `fr`, `de`, `zh`, `it`) instead of `spanish`/`english`
- `originalLanguage` field marks the source language

### 3. Explanations
- **Line explanations**: i18n objects `{ "en": "...", "es": "...", ... }`
- **Section explanations**: i18n objects `{ "en": "...", "es": "...", ... }`
- Can be `null` for grouping (frontend concatenates nulls until next explanation)

### 4. Section Identification
- Sections use `start_ms` and `end_ms` ranges (not duplicate line arrays)
- Frontend matches sections to lyrics by timestamp ranges
- Sections can repeat (e.g., multiple Choruses with different ranges)

### 5. Metadata
- Includes `videoId`, `title`, `artist`, `thumbnailUrl`
- `originalLanguage` for language detection
- `transcribedAt` timestamp

## Intermediate Formats

### `data/transcribed-lyrics/{videoId}.json`
```json
{
  "videoId": "...",
  "title": "...",
  "artist": "...",
  "thumbnailUrl": "...",
  "language": "es",
  "segments": [
    {
      "text": "...",
      "start_ms": 0,
      "end_ms": 2000
    }
  ],
  "transcribedAt": "..."
}
```

### `data/analyzed-lyrics/{videoId}.json`
```json
{
  "videoId": "...",
  "title": "...",
  "artist": "...",
  "thumbnailUrl": "...",
  "originalLanguage": "es",
  "lyrics": [
    {
      "text": "...",
      "start_ms": 0,
      "end_ms": 2000,
      "explanation": "English explanation of meaning, culture, or slang. Can be null for grouping."
    }
  ],
  "structuredSections": [
    {
      "title": "Intro",
      "sectionExplanation": "English explanation of the section's purpose or theme.",
      "start_ms": 0,
      "end_ms": 2000
    }
  ]
}
```

**Note:** Explanations and section titles are in English only at this stage. The translation step will convert them to i18n objects with all target languages.

## Section Matching Logic

To get lines for a section:
```typescript
function getSectionLines(section, lyrics) {
  return lyrics.filter(lyric => 
    lyric.start_ms >= section.start_ms && 
    lyric.end_ms <= section.end_ms
  );
}
```

## Supported Languages

- `es` - Spanish (original)
- `en` - English (primary translation)
- `fr` - French
- `de` - German
- `zh` - Chinese
- `it` - Italian

## Section Title Standards

Section titles are generated by the LLM and translated into all supported languages:
- Common sections: Intro, Verse, Verse 1/2/3, Chorus, Bridge, Outro, Interlude, Lyrics
- Custom section titles are also generated and translated by the LLM

